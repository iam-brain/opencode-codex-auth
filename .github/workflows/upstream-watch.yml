name: Upstream Watch

on:
  schedule:
    - cron: "17 14 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  upstream-watch:
    name: Check upstream plugin drift
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 20.x

      - name: Check upstream tracked files
        id: check
        continue-on-error: true
        run: |
          set -euo pipefail
          set +e
          node scripts/check-upstream-watch.js | tee upstream-watch-report.txt
          EXIT_CODE=$?
          set -e
          echo "exit_code=${EXIT_CODE}" >> "$GITHUB_OUTPUT"
          if [ "${EXIT_CODE}" -eq 1 ]; then
            exit 1
          fi
          if [ "${EXIT_CODE}" -eq 2 ]; then
            echo "Operational upstream-watch failure (issue creation suppressed)." >&2
            exit 0
          fi

      - name: Upload upstream watch report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: upstream-watch-report
          path: upstream-watch-report.txt

      - name: Create or update upstream drift issue
        if: steps.check.outputs.exit_code == '1'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7
        with:
          script: |
            const title = "Upstream parity watch: tracked GitHub source changed"
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            const marker = "<!-- upstream-watch -->"
            const body = `${marker}
            Detected upstream drift in one or more tracked upstream GitHub sources.

            - Workflow run: ${runUrl}
            - Next step: run \`npm run check:upstream\`, review diffs, then apply updates.
            - After syncing, run \`npm run check:upstream:update\` and commit \`docs/development/upstream-watch.json\`.
            `

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            })

            const existing = issues.find((issue) => issue.title === title)
            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body
              })
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body
              })
            }

      - name: Fail when upstream drift detected
        if: steps.check.outputs.exit_code == '1'
        run: exit 1

      - name: Fail on upstream operational error
        if: steps.check.outputs.exit_code == '2'
        run: exit 1
